#!/bin/bash
#
# Copyright (C) 2006 - 2014 FOSS-Group
#                    Germany
#                    http://www.foss-group.de
#                    support@foss-group.de
# Authors:
# Beat Stebler <beat.stebler@foss-group.ch>
#  
# Licensed under the EUPL, Version 1.1 or higher as soon they
# will be approved by the European Commission - subsequent
# versions of the EUPL (the "Licence"); You may not use this
# work except in compliance with the Licence.
# 
# You may obtain a copy of the Licence at:
# https://joinup.ec.europa.eu/software/page/eupl
#
# Unless required by applicable law or agreed to in
# writing, software distributed under the Licence is
# distributed on an "AS IS" basis,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
# express or implied.
# See the Licence for the specific language governing
# permissions and limitations under the Licence.
#

######################################################################################################
# Description:
#   Check variables of user entered with the call of this script
#   autobuild.sh pre  or autobuild.sh final
######################################################################################################

######################################################################################################
# Variables
######################################################################################################

# current folder 
currentPwd=$(pwd)

# branch on portage
cd /usr/portage
portageBranch=$(git status | grep branch -m 1 | cut -d " " -f 3)

# branch on portage overlay
cd /var/lib/layman/foss-cloud
portageOverlayBranch=$(git status | grep branch -m 1 | cut -d " " -f 3)

updateMode=$1

######################################################################################################
# FOSS-Cloud logo
######################################################################################################

logoFOSS-Cloud ()  {
clear

cat << \EOF >&1

                     __________  __________       ________                __
                    / ____/ __ \/ ___/ ___/      / ____/ /___  __  ______/ /
                   / /_  / / / /\__ \\__ \______/ /   / / __ \/ / / / __  /
                  / __/ / /_/ /___/ /__/ /_____/ /___/ / /_/ / /_/ / /_/ /
                 /_/    \____//____/____/      \____/_/\____/\__,_/\__,_/
EOF
}

######################################################################################################
# Update portage and Overlay
######################################################################################################


logoFOSS-Cloud
echo ""
echo "-----------------------------------------------------------------------------------------------"
echo "   Updating portage and portage-overlays..."
echo "-----------------------------------------------------------------------------------------------"
echo ""

echo "RUN       : Update DB portage-overlay"
layman -s foss-cloud

cd /var/lib/layman/foss-cloud
if [[ $updateMode == "hard" ]] ; then
    echo "RUN       : Reset portage-overlay foss-cloud"
    git reset --hard
fi

git pull -f

echo "RUN       : Checkout branch on portage-overlay" 
cd /var/lib/layman/foss-cloud
git checkout $portageOverlayBranch

echo "RUN       : Setting permission portage-overlay" 
chmod -R 755 /var/lib/layman/foss-cloud/
chown -R portage:portage /var/lib/layman/foss-cloud/

cd /usr/portage
if [[ $updateMode == "hard" ]] ; then
    echo "RUN       : Reset portage"
    git reset --hard
fi

git pull -f

echo "RUN       : Checkout branch on portage" 
cd /usr/portage
git checkout $portageBranch

echo "RUN       : Setting permission portage" 
chmod -R 755 /usr/portage
chown -R portage:portage /usr/portage/


cd $currentPwd

echo ""
echo "-----------------------------------------------------------------------------------------------"
echo "   Portage and portage-overlay are up to date now"
echo "-----------------------------------------------------------------------------------------------"

